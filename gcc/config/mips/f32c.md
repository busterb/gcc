;;
;; f32c pipeline description
;;


(define_automaton "f32c_cpu, f32c_mdu")

;; Integer execution unit.
(define_cpu_unit "f32c_ixu_arith"       "f32c_cpu")
(define_cpu_unit "f32c_ixu_mpydiv"      "f32c_mdu")

(define_insn_reservation "f32c_int_load" 3
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "load"))
  "f32c_ixu_arith")

(define_insn_reservation "f32c_int_store" 1
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "store"))
  "f32c_ixu_arith")

(define_bypass 3 "f32c_int_load"   "f32c_int_store")

(define_insn_reservation "f32c_int_mult" 1
  (and (eq_attr "cpu" "f32c")
       (and (eq_attr "type" "imul,imadd")
	    (eq_attr "mode" "SI")))
  "f32c_ixu_arith+(f32c_ixu_mpydiv*2)")

(define_insn_reservation "f32c_int_mfhilo" 1
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "mfhi,mflo"))
  "f32c_ixu_arith+f32c_ixu_mpydiv")

(define_insn_reservation "f32c_int_shift" 2
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "shift"))
  "f32c_ixu_arith")

(define_insn_reservation "f32c_condmove" 2
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "condmove"))
  "f32c_ixu_arith")

;; All other integer insns.
(define_insn_reservation "f32c_int_alu" 1
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "arith,const,logical,move,nop,signext,slt"))
  "f32c_ixu_arith")

(define_insn_reservation "f32c_int_branch" 1
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "branch"))
  "f32c_ixu_arith")

;; JR/JALR.
(define_insn_reservation "f32c_int_jump" 1
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "jump,call"))
  "f32c_ixu_arith")

;; Any    -> JR/JALR (without dependency) : 1 clock issue delay
;; Load   -> JR/JALR (with dependency)    : 3 clock issue delay
;; Shift  -> JR/JALR (with dependency)    : 3 clock issue delay
;; Any    -> JR/JALR (with dependency)    : 2 clock issue delay
(define_bypass 3 "f32c_int_load"   "f32c_int_jump")
(define_bypass 3 "f32c_int_shift"  "f32c_int_jump")
(define_bypass 2 "f32c_int_alu"    "f32c_int_jump")
(define_bypass 2 "f32c_int_mfhilo" "f32c_int_jump")

;; Unknown 
(define_insn_reservation "f32c_int_unknown" 1
  (and (eq_attr "cpu" "f32c")
       (eq_attr "type" "unknown,multi"))
  "f32c_ixu_arith+f32c_ixu_mpydiv")


;; Substitute sll %0,%1,1 with addu %0,%1,%1
(define_insn "*ashl<mode>3"
  [(set (match_operand:GPR 0 "register_operand" "=d")
        (ashift:GPR (match_operand:GPR 1 "register_operand" "d")
                       (match_operand:SI 2 "arith_operand" "dI")))]
  "TARGET_F32C"
{
  if (CONST_INT_P (operands[2]))
    operands[2] = GEN_INT (INTVAL (operands[2])
                           & (GET_MODE_BITSIZE (<MODE>mode) - 1));
                               
  if (CONST_INT_P (operands[2]) && INTVAL (operands[2]) == 1)
    return "addu\t%0,%1,%1";
  else
    return "sll\t%0,%1,%2";
}
  [(set_attr "type" "shift")
   (set_attr "mode" "<MODE>")])

